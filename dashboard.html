<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLTY PRO | Thermal Engineering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; }
        .input-group { background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 10px; }
        label { display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 5px; }
        input, select { width: 100%; background: #0f172a; border: 1px solid #475569; color: white; padding: 8px; border-radius: 4px; }
        .btn-calc { background: linear-gradient(90deg, #ea580c, #c2410c); width: 100%; padding: 12px; font-weight: bold; border-radius: 6px; margin-top: 10px; }
        .btn-calc:hover { opacity: 0.9; }
    </style>
</head>
<body class="p-4 max-w-7xl mx-auto">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-orange-500">MOLTY <span class="text-white text-sm">ADVANCED GEOMETRY</span></h1>
        <div id="status" class="text-xs text-green-500">‚óè System Ready</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-4">
            
            <div class="input-group border-l-4 border-blue-500">
                <h3 class="text-white font-bold mb-3">1. GEOMETRIJA OBJEKTA</h3>
                
                <label>Tip Objekta</label>
                <select id="geo-type" onchange="toggleGeo()">
                    <option value="flat">Ravan Zid (Peƒá/Zid)</option>
                    <option value="cylinder">Cilindar (Lonac/Cev)</option>
                </select>

                <div id="dim-flat" class="mt-3">
                    <label>Povr≈°ina Zida (m¬≤)</label>
                    <input type="number" id="area-m2" value="10">
                </div>

                <div id="dim-cyl" class="mt-3 hidden">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label>Visina/Du≈æina (m)</label>
                            <input type="number" id="cyl-height" value="3.5">
                        </div>
                        <div>
                            <label>Spoljni Preƒçnik (mm)</label>
                            <input type="number" id="cyl-dia" value="3000">
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-group border-l-4 border-orange-500">
                <h3 class="text-white font-bold mb-3">2. PROCES</h3>
                <label>Metal / Legura</label>
                <select id="metal-select"></select>
                
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <div>
                        <label>Temp. Metala (¬∞C)</label>
                        <input type="number" id="t-hot" value="1600">
                    </div>
                    <div>
                        <label>Ambijent (¬∞C)</label>
                        <input type="number" id="t-amb" value="25">
                    </div>
                </div>
            </div>

            <div class="input-group border-l-4 border-gray-500">
                <h3 class="text-white font-bold mb-3">3. VATROSTALNI SLOJEVI</h3>
                <div id="layers-container" class="space-y-2"></div>
                <button onclick="addLayerUI()" class="text-xs text-blue-400 mt-2 hover:underline">+ Dodaj sloj</button>
            </div>

            <button onclick="runSim()" class="btn-calc">IZRAƒåUNAJ üöÄ</button>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-800 p-4 rounded border border-slate-700">
                    <div class="text-gray-400 text-xs">Temp. Pla≈°ta</div>
                    <div class="text-2xl font-bold text-white"><span id="res-shell">0</span> ¬∞C</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border border-slate-700">
                    <div class="text-gray-400 text-xs">Toplotni Fluks</div>
                    <div class="text-2xl font-bold text-orange-500"><span id="res-flux">0</span> W/m¬≤</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border border-slate-700">
                    <div class="text-gray-400 text-xs">Ukupna Te≈æina</div>
                    <div class="text-2xl font-bold text-blue-500"><span id="res-weight">0</span> kg</div>
                </div>
                <div class="bg-slate-800 p-4 rounded border border-slate-700">
                    <div class="text-gray-400 text-xs">Cena Materijala</div>
                    <div class="text-2xl font-bold text-green-500"><span id="res-cost">0</span> ‚Ç¨</div>
                </div>
            </div>

            <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-900 text-gray-400">
                        <tr>
                            <th class="p-3">Sloj</th>
                            <th class="p-3">Debljina</th>
                            <th class="p-3">Temp (Hladna str.)</th>
                            <th class="p-3">Te≈æina</th>
                            <th class="p-3">Cena</th>
                        </tr>
                    </thead>
                    <tbody id="bom-body" class="text-slate-200"></tbody>
                </table>
            </div>

            <div class="bg-slate-800 p-2 rounded border border-slate-700 h-80">
                <canvas id="mainChart"></canvas>
            </div>
            
            <div class="text-right text-xs text-gray-600 mt-2">
                Liquidus Limit: <span id="liq-limit" class="text-red-500 font-bold">---</span> ¬∞C
            </div>
        </div>
    </div>

    <script>
        let MATS = [];
        let CHART = null;

        // INICIJALIZACIJA
        window.onload = async () => {
            try {
                const r = await fetch('/api/init');
                const d = await r.json();
                MATS = d.materials;
                
                // Popuni metale
                const sel = document.getElementById('metal-select');
                for(let m in d.metals) sel.innerHTML += `<option value="${m}">${m}</option>`;
                
                addLayerUI(); // Prvi sloj
            } catch(e) { console.error(e); }
        };

        // UI LOGIKA ZA GEOMETRIJU
        function toggleGeo() {
            const type = document.getElementById('geo-type').value;
            if(type === 'cylinder') {
                document.getElementById('dim-flat').classList.add('hidden');
                document.getElementById('dim-cyl').classList.remove('hidden');
            } else {
                document.getElementById('dim-flat').classList.remove('hidden');
                document.getElementById('dim-cyl').classList.add('hidden');
            }
        }

        // DODAVANJE SLOJEVA
        function addLayerUI() {
            const div = document.createElement('div');
            div.className = "flex gap-2 layer-row";
            let opts = MATS.map(m => `<option value="${m.name}" data-lam="${m.lambda_val}" data-den="${m.density}" data-price="${m.price}">${m.name}</option>`).join('');
            div.innerHTML = `
                <select class="l-mat text-xs w-2/3">${opts}</select>
                <input type="number" class="l-th text-xs w-1/3" value="100" placeholder="mm">
            `;
            document.getElementById('layers-container').appendChild(div);
        }

        // GLAVNA FUNKCIJA
        async function runSim() {
            const layers = [];
            document.querySelectorAll('.layer-row').forEach(r => {
                const sel = r.querySelector('.l-mat');
                const opt = sel.options[sel.selectedIndex];
                layers.push({
                    material: sel.value,
                    thickness: parseFloat(r.querySelector('.l-th').value),
                    lambda_val: parseFloat(opt.dataset.lam),
                    density: parseFloat(opt.dataset.den),
                    price: parseFloat(opt.dataset.price)
                });
            });

            // PRIPREMA GEOMETRIJE ZA BACKEND
            const gType = document.getElementById('geo-type').value;
            let geom = { type: gType };
            
            if(gType === 'cylinder') {
                // Za cilindar ≈°aljemo visinu kao dim1 i preƒçnik
                geom.dim1 = parseFloat(document.getElementById('cyl-height').value);
                geom.diameter = parseFloat(document.getElementById('cyl-dia').value);
            } else {
                // Za ravan zid ≈°aljemo povr≈°inu kao dim1
                geom.dim1 = parseFloat(document.getElementById('area-m2').value);
            }

            const payload = {
                metal: document.getElementById('metal-select').value,
                target_temp: parseFloat(document.getElementById('t-hot').value),
                ambient_temp: parseFloat(document.getElementById('t-amb').value),
                layers: layers,
                geometry: geom
            };

            const btn = document.querySelector('.btn-calc');
            btn.innerHTML = "RAƒåUNAM...";

            try {
                const req = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await req.json();

                // POPUNJAVANJE REZULTATA
                document.getElementById('res-shell').innerText = res.shell_temp;
                document.getElementById('res-flux').innerText = res.heat_flux;
                document.getElementById('res-weight').innerText = res.total_weight;
                document.getElementById('res-cost').innerText = res.total_cost;
                document.getElementById('liq-limit').innerText = res.liquidus_temp;

                // POPUNJAVANJE TABELE
                const tbody = document.getElementById('bom-body');
                tbody.innerHTML = "";
                res.bom.forEach(item => {
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-700">
                            <td class="p-2">${item.name}</td>
                            <td class="p-2 text-orange-400">${item.th} mm</td>
                            <td class="p-2">${item.temp} ¬∞C</td>
                            <td class="p-2">${item.w} kg</td>
                            <td class="p-2">${item.cost} ‚Ç¨</td>
                        </tr>
                    `;
                });

                renderChart(res.profile, res.liquidus_temp);

            } catch(e) {
                console.error(e);
                alert("Gre≈°ka! Proveri konzolu.");
            }
            btn.innerHTML = "IZRAƒåUNAJ üöÄ";
        }

        function renderChart(data, limit) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(CHART) CHART.destroy();
            
            CHART = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.pos + ' mm'),
                    datasets: [{
                        label: 'Temp (¬∞C)',
                        data: data.map(d => d.temp),
                        borderColor: '#f97316',
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Liquidus',
                        data: Array(data.length).fill(limit),
                        borderColor: 'red',
                        borderDash: [5,5],
                        borderWidth: 1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: {color: '#334155'}, ticks: {color:'#94a3b8'} },
                        x: { display: false }
                    },
                    plugins: { legend: {display: false} }
                }
            });
        }
    </script>
</body>
</html>
