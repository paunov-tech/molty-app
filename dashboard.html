<!DOCTYPE html>
<html lang="sr" class="dark">
<head>
<meta charset="UTF-8">
<title>MOLTY PRO V3.2 - AI Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    body { background: #0b0d12; color: #cfd8dc; font-family: 'Chakra Petch', sans-serif; height: 100vh; overflow: hidden; }
    .glass { background: #12151b; border: 1px solid #2d333b; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .input-cad { background: #0d1117; border: 1px solid #30363d; color: #e6edf3; text-align: center; width: 100%; padding: 6px; font-weight: 600; font-size: 12px; }
    .tab-btn { padding: 10px 20px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; color: #8b949e; transition: all 0.3s; }
    .tab-btn.active { color: #58a6ff; border-bottom: 2px solid #58a6ff; background: #161b22; }
    .email-box { background: #ffffff; color: #333; font-family: Arial, sans-serif; padding: 20px; border-radius: 4px; font-size: 13px; line-height: 1.5; border: 1px solid #ccc; height: 100%; overflow-y: auto; }
    .traffic { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 5px currentColor; }
    .ok { background: #3fb950; color: #3fb950; } .warn { background: #f85149; color: #f85149; }
    
    /* Šrafure */
    .pat-0 { background-color: #1e293b; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 2px, transparent 2px, transparent 10px); }
    .pat-1 { background-color: #334155; background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 8px 8px; }
    .pat-2 { background-color: #0f172a; background-image: linear-gradient(0deg, transparent 24%, rgba(88, 166, 255, .1) 25%, rgba(88, 166, 255, .1) 26%, transparent 27%, transparent 74%, rgba(88, 166, 255, .2) 75%, rgba(88, 166, 255, .2) 76%, transparent 77%, transparent); background-size: 20px 20px; }

    #freeze-line { position: absolute; top: 0; bottom: 0; width: 3px; border-left: 3px dashed #00e5ff; z-index: 50; pointer-events: none; box-shadow: 0 0 15px #00e5ff; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-content { background: #161b22; width: 700px; max-height: 80vh; overflow-y: auto; border: 1px solid #30363d; padding: 20px; border-radius: 8px; }
    ::-webkit-scrollbar { width: 6px; background: #0d1117; } ::-webkit-scrollbar-thumb { background: #30363d; }
</style>
</head>
<body class="flex flex-col h-full">

    <div class="h-12 bg-[#0d1117] border-b border-[#30363d] flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold text-white tracking-widest"><i class="fa-solid fa-robot text-[#58a6ff]"></i> MOLTY PRO</h1>
            <div class="flex">
                <div class="tab-btn active" onclick="switchTab('tech', this)"><i class="fa-solid fa-microchip mr-2"></i> INŽENJERING</div>
                <div class="tab-btn" onclick="switchTab('comm', this)"><i class="fa-solid fa-file-invoice-dollar mr-2"></i> KOMERCIJALA</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <input list="clientsList" id="clientName" class="input-cad text-left uppercase w-64 border-[#1f6feb]" value="METALFER STEEL MILL">
            <datalist id="clientsList"></datalist>
            <button onclick="saveProject()" class="bg-[#238636] text-white px-3 py-1 rounded text-[10px] font-bold"><i class="fa-solid fa-floppy-disk mr-1"></i> SNIMI</button>
            <button onclick="openHistory()" class="bg-[#1f6feb] text-white px-3 py-1 rounded text-[10px] font-bold"><i class="fa-solid fa-history mr-1"></i> ISTORIJA</button>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        
        <div id="view-tech" class="flex flex-1">
            <div class="w-[350px] flex flex-col border-r border-[#30363d] bg-[#0d1117] p-4 overflow-y-auto">
                <div class="glass p-3 rounded mb-4">
                    <label class="text-[10px] text-[#58a6ff] uppercase font-bold mb-1 block">Peć / Lonac</label>
                    <select id="metalType" class="input-cad mb-2 text-left text-[#ff7b72]"></select>
                    <select id="shape" onchange="uiT()" class="input-cad text-left"><option value="cylinder">ROTACIONA PEĆ</option><option value="flat">RAVNI ZID</option></select>
                </div>
                <div class="glass p-3 rounded mb-4">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label id="lbl-dim1" class="text-[9px] text-gray-500 block">Dužina (m)</label><input type="number" id="dim1" value="5" class="input-cad"></div>
                        <div id="box-dim2"><label class="text-[9px] text-yellow-600 block">Unutra Ø (mm)</label><input type="number" id="dim2" value="2800" class="input-cad text-yellow-500"></div>
                    </div>
                </div>
                <button onclick="addLayer()" class="bg-[#238636] text-white w-full py-2 rounded font-bold text-xs mb-4">+ DODAJ SLOJ</button>
                <div id="layers" class="space-y-2 pb-10"></div>
                <button onclick="calc()" id="btnCalc" class="w-full bg-[#1f6feb] text-white py-3 rounded font-bold mt-auto sticky bottom-0">IZRAČUNAJ</button>
            </div>

            <div class="flex-1 bg-[#010409] p-6 overflow-y-auto relative">
                <div id="hud" class="hidden glass p-4 mb-4 flex justify-between items-center rounded">
                    <div class="flex gap-8">
                        <div><p class="text-[9px] text-gray-500">LIQUIDUS</p><p class="text-xl font-bold text-[#ff7b72]" id="res-liq">0</p></div>
                        <div><p class="text-[9px] text-gray-500">FREEZE DEPTH</p><p class="text-xl font-bold text-white"><span id="light-s" class="traffic ok"></span> <span id="res-freeze">0</span></p></div>
                    </div>
                    <div class="text-right text-xs">
                        TOTAL: <b id="res-weight">0</b> kg | CENA: <b id="res-cost">0</b> €
                    </div>
                </div>
                
                <div id="results" class="hidden">
                    <div class="h-32 w-full bg-[#0d1117] border border-[#30363d] mb-4 flex overflow-hidden rounded relative">
                        <div id="viz" class="flex-1 flex h-full"></div>
                        <div id="freeze-line"></div>
                    </div>
                    <div class="glass overflow-hidden mb-4 rounded">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-[#161b22] text-[#8b949e]"><tr><th class="p-3">MATERIJAL</th><th class="text-right">mm</th><th class="text-right">TEMP</th><th class="text-right">KG</th><th class="text-right pr-4">€</th></tr></thead>
                            <tbody id="tb" class="divide-y divide-[#30363d]"></tbody>
                        </table>
                    </div>
                    <div class="h-64 glass p-2 rounded"><canvas id="ch"></canvas></div>
                </div>
                <div id="empty" class="h-full flex flex-col items-center justify-center opacity-10"><i class="fa-solid fa-industry text-9xl"></i></div>
            </div>
        </div>

        <div id="view-comm" class="hidden flex-1 bg-[#010409] p-6 flex flex-col gap-6 overflow-y-auto">
            
            <div class="glass p-5 rounded-lg border border-[#30363d]">
                <h3 class="text-white font-bold mb-4 flex items-center gap-2 text-lg"><i class="fa-brands fa-google-drive text-[#34a853]"></i> Google Drive Komercijalna Arhiva</h3>
                <div class="flex gap-3 mb-4">
                    <select id="driveClientSelect" class="bg-[#0d1117] border border-[#30363d] text-white p-2 rounded flex-1">
                        <option value="">Učitavanje klijenata...</option>
                    </select>
                    <button onclick="scanClientArchive()" class="bg-[#238636] hover:bg-[#2ea043] text-white px-6 py-2 rounded font-bold">
                        <i class="fa-solid fa-magnifying-glass mr-2"></i> SKENIRAJ
                    </button>
                </div>

                <div id="archiveLoader" class="hidden text-center p-10">
                    <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-blue-500"></div>
                    <p class="mt-2 text-gray-500">AI pretražuje foldere...</p>
                </div>

                <div id="archiveTableBox" class="hidden">
                    <table class="w-full text-xs text-left border border-[#30363d]">
                        <thead class="bg-[#161b22] text-gray-400">
                            <tr><th class="p-3">GODINA</th><th>TIP</th><th>DOKUMENT</th><th class="text-right p-3">AKCIJE</th></tr>
                        </thead>
                        <tbody id="archiveList" class="divide-y divide-[#30363d] text-gray-300"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex gap-6 flex-1 min-h-[400px]">
                <div class="w-1/3 glass p-5 rounded border border-[#30363d]">
                    <h4 class="font-bold text-white mb-4"><i class="fa-solid fa-paper-plane text-blue-400"></i> Sonja RFQ Gen</h4>
                    <button onclick="exp('excel')" class="w-full bg-[#161b22] border border-[#30363d] text-white py-3 rounded mb-3 hover:bg-[#21262d]">1. PREUZMI EXCEL</button>
                    <button onclick="copyEmail()" class="w-full bg-[#1f6feb] text-white py-3 rounded hover:bg-[#388bfd]">2. KOPIRAJ MEJL</button>
                </div>
                <div class="flex-1 flex flex-col">
                    <div id="email-preview-container" class="email-box">
                        <div id="email-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal"><div class="modal-content"><div id="historyList"></div></div></div>

    <script>
        let MATS=[], METALS={}, LAST=null, CH=null;

        window.onload = async () => {
            try {
                const r = await fetch('/api/init'); d = await r.json();
                MATS = d.materials; METALS = d.metals;
                const ms = document.getElementById('metalType'); 
                for(let m in METALS) ms.innerHTML += `<option value="${m}">${m}</option>`;
                const cl = document.getElementById('clientsList');
                d.clients.forEach(c => cl.innerHTML += `<option value="${c}">`);
                addLayer();
                loadDriveClients(); // Učitaj Drive klijente odmah
            } catch(e) { console.error(e); }
        };

        function switchTab(t, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('view-tech').classList.toggle('hidden', t!=='tech');
            document.getElementById('view-comm').classList.toggle('hidden', t!=='comm');
            if(t==='comm' && LAST) updateMailPreview();
        }

        // --- DRIVE LOGIKA ---
        async function loadDriveClients() {
            const res = await fetch('/api/drive/test-scan');
            const data = await res.json();
            const sel = document.getElementById('driveClientSelect');
            if(data.status === 'success') {
                sel.innerHTML = '<option value="">Izaberi klijenta sa Drive-a...</option>';
                data.found_clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            }
        }

        async function scanClientArchive() {
            const select = document.getElementById('driveClientSelect');
            const fid = select.value;
            const cName = select.options[select.selectedIndex].text;
            if(!fid) return alert("Izaberi klijenta!");

            document.getElementById('archiveLoader').classList.remove('hidden');
            document.getElementById('archiveTableBox').classList.add('hidden');

            const res = await fetch(`/api/drive/scan-deep/${fid}`);
            const data = await res.json();
            const list = document.getElementById('archiveList');
            list.innerHTML = '';

            if(data.status === 'success' && data.files.length > 0) {
                data.files.forEach(f => {
                    list.innerHTML += `<tr class="hover:bg-[#161b22]">
                        <td class="p-3"><span class="bg-gray-800 px-2 py-1 rounded text-[10px]">${f.godina}</span></td>
                        <td><small class="text-blue-400">${f.tip}</small></td>
                        <td class="max-w-xs truncate">${f.ime}</td>
                        <td class="text-right p-3">
                            <a href="https://drive.google.com/file/d/${f.id}/view" target="_blank" class="text-gray-400 hover:text-white mr-3"><i class="fa-solid fa-eye"></i></a>
                            <button onclick="runAiAnalysis('${f.id}', '${cName}')" class="bg-[#f0883e]/10 text-[#f0883e] border border-[#f0883e]/20 px-2 py-1 rounded text-[10px] hover:bg-[#f0883e]/20">
                                <i class="fa-solid fa-robot mr-1"></i> ANALIZIRAJ
                            </button>
                        </td>
                    </tr>`;
                });
                document.getElementById('archiveTableBox').classList.remove('hidden');
            } else { alert("Nema dokumenata u folderima Fakture/Ponude."); }
            document.getElementById('archiveLoader').classList.add('hidden');
        }

        async function runAiAnalysis(fid, cName) {
            const btn = event.target.closest('button');
            const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i>';
            
            try {
                const r = await fetch(`/api/drive/analyze-file/${fid}?client_name=${encodeURIComponent(cName)}`);
                const d = await r.json();
                if(d.status === 'success') {
                    alert(`✅ AI ANALIZA USPEŠNA!\n\nTonaža: ${d.extracted.weight} t\nCena: ${d.extracted.price} €\nKlijent: ${cName}\n\nPodaci upisani u bazu.`);
                } else { alert("AI nije uspeo da dešifruje ovaj PDF."); }
            } catch(e) { alert("Greška u komunikaciji sa AI serverom."); }
            btn.disabled = false; btn.innerHTML = old;
        }

        // --- OSTALE FUNKCIJE (TECH) ---
        function addLayer() {
            const d = document.createElement('div'); d.className = 'bg-[#161b22] p-2 border border-[#30363d] rounded relative group';
            let opt = ''; MATS.forEach(m => opt += `<option value="${m.name}">${m.name}</option>`);
            d.innerHTML = `<select onchange="upd(this)" class="input-cad text-left mb-1 text-[#f0883e]">${opt}</select>
                <div class="grid grid-cols-4 gap-1">
                    <input type="number" class="th input-cad" value="114">
                    <input type="number" class="l input-cad text-purple-400">
                    <input type="number" class="d input-cad text-green-400">
                    <input type="number" class="p input-cad text-blue-400">
                </div>`;
            document.getElementById('layers').appendChild(d);
            upd(d.querySelector('select'));
        }

        function upd(s) {
            const m = MATS.find(x=>x.name===s.value);
            if(m) {
                const r = s.parentElement;
                r.querySelector('.l').value = m.lambda_val;
                r.querySelector('.d').value = m.density;
                r.querySelector('.p').value = m.price;
            }
        }

        async function calc() {
            const l = []; document.querySelectorAll('#layers > div').forEach(r=>{
                l.push({ material: r.querySelector('select').value, thickness: parseFloat(r.querySelector('.th').value), 
                         lambda_val: parseFloat(r.querySelector('.l').value), density: parseFloat(r.querySelector('.d').value), price: parseFloat(r.querySelector('.p').value)});
            });
            const res = await fetch('/api/simulate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                metal: document.getElementById('metalType').value, target_temp: parseFloat(document.getElementById('dim1').value), 
                ambient_temp: 30, layers: l, geometry: {type:'flat', dim1:1, dim2:0}
            })});
            LAST = await res.json(); render(LAST);
        }

        function render(d) {
            document.getElementById('empty').classList.add('hidden'); document.getElementById('hud').classList.remove('hidden'); document.getElementById('results').classList.remove('hidden');
            document.getElementById('res-liq').innerText = d.shell_temp + "°C";
            let h = ''; d.bom.forEach((i, idx) => {
                h += `<tr class="border-b border-[#30363d]">
                    <td class="p-3 font-bold">${i.name}</td>
                    <td class="text-right">${i.th}</td>
                    <td class="text-right text-red-400">${i.temp}°</td>
                    <td class="text-right">${i.w}</td>
                    <td class="text-right pr-4 font-bold text-blue-400">${i.cost.toFixed(2)}</td>
                </tr>`;
            });
            document.getElementById('tb').innerHTML = h;
            // Grafikon
            if(CH) CH.destroy();
            CH = new Chart(document.getElementById('ch'), {type:'line', data:{labels:d.bom.map(b=>b.name), datasets:[{data:d.bom.map(b=>b.temp), borderColor:'#58a6ff', fill:true}]}, options:{responsive:true, maintainAspectRatio:false}});
        }
        
        function uiT() {} // Placeholder za tvoju uiT logiku
        function saveProject() { alert("Sačuvano!"); }
        function openHistory() { alert("Istorija učitana!"); }
    </script>
</body>
</html>
