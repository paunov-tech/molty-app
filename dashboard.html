<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLTY | Final System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #111; color: white; font-family: sans-serif; padding: 20px; }
        .box { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; }
        input, select { background: #333; color: white; border: 1px solid #555; padding: 8px; width: 100%; border-radius: 5px; }
        .btn { background: #f97316; color: white; font-weight: bold; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #ea580c; }
        .result-val { font-size: 24px; font-weight: bold; font-family: monospace; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1 class="text-2xl font-bold mb-5 text-orange-500">MOLTY PRODUCTION v3.0</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <div class="box">
            <h2 class="text-xl mb-4 text-gray-400">1. Parametri</h2>
            
            <label class="text-sm">Metalna Legura</label>
            <select id="sim-metal" class="mb-4"></select>
            
            <label class="text-sm">Ciljna Temperatura (¬∞C)</label>
            <input type="number" id="sim-temp" value="1600" class="mb-4">
            
            <label class="text-sm">Ambijent (¬∞C)</label>
            <input type="number" id="sim-amb" value="25" class="mb-6">

            <hr class="border-gray-700 mb-4">
            
            <div id="layers-list"></div>
            
            <button onclick="addLayerUI()" class="text-sm text-gray-400 underline mb-4">+ Dodaj sloj</button>
            <button onclick="runSimulation()" class="btn">POKRENI SIMULACIJU üöÄ</button>
        </div>

        <div class="box md:col-span-2">
            <h2 class="text-xl mb-4 text-gray-400">2. Rezultati</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="p-3 bg-gray-800 rounded">
                    <div class="text-xs text-gray-500">Temp. Pla≈°ta</div>
                    <div id="out-shell" class="result-val text-white">0 ¬∞C</div>
                </div>
                <div class="p-3 bg-gray-800 rounded">
                    <div class="text-xs text-gray-500">Toplotni Fluks</div>
                    <div id="out-flux" class="result-val text-orange-400">0 W/m¬≤</div>
                </div>
                <div class="p-3 bg-gray-800 rounded">
                    <div class="text-xs text-gray-500">Taƒçka Likvidusa</div>
                    <div id="out-liq" class="result-val text-red-500">---</div>
                </div>
                <div class="p-3 bg-gray-800 rounded">
                    <div class="text-xs text-gray-500">Ukupna Cena</div>
                    <div id="out-cost" class="result-val text-green-500">0 ‚Ç¨</div>
                </div>
            </div>

            <div style="height: 300px; width: 100%;">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let MATERIALS = [];
        let CHART = null;

        // 1. UƒåITAVANJE PRI STARTU
        window.onload = async function() {
            try {
                const res = await fetch('/api/init');
                if(!res.ok) throw new Error("API nedostupan");
                const data = await res.json();
                
                MATERIALS = data.materials; // ƒåuvamo materijale
                
                // Popuni metale
                const sel = document.getElementById('sim-metal');
                sel.innerHTML = "";
                for (const [key, val] of Object.entries(data.metals)) {
                    sel.innerHTML += `<option value="${key}">${key} (T.top: ${val}¬∞C)</option>`;
                }

                addLayerUI(); // Dodaj prvi sloj
            } catch (e) {
                alert("Gre≈°ka: Server se jo≈° budi. Osve≈æi za 30 sekundi.");
                console.error(e);
            }
        };

        // 2. FUNKCIJA ZA DODAVANJE SLOJEVA U UI
        function addLayerUI() {
            const container = document.getElementById('layers-list');
            const div = document.createElement('div');
            div.className = "row";
            
            let options = MATERIALS.map(m => `<option value="${m.name}" data-lam="${m.lambda_val}" data-den="${m.density}" data-price="${m.price}">${m.name}</option>`).join('');
            
            div.innerHTML = `
                <select class="layer-select" style="flex:2">${options}</select>
                <input type="number" class="layer-th" value="100" style="flex:1" placeholder="mm">
            `;
            container.appendChild(div);
        }

        // 3. GLAVNA FUNKCIJA KOJA SALJE PODATKE NA SERVER
        async function runSimulation() {
            const btn = document.querySelector('button[onclick="runSimulation()"]');
            btn.innerText = "RAƒåUNAM...";
            
            // Skupljamo podatke iz HTML-a
            const layersData = [];
            document.querySelectorAll('#layers-list .row').forEach(row => {
                const sel = row.querySelector('.layer-select');
                const th = row.querySelector('.layer-th');
                const opt = sel.options[sel.selectedIndex];
                
                layersData.push({
                    material: sel.value,
                    thickness: parseFloat(th.value),
                    lambda_val: parseFloat(opt.dataset.lam),
                    density: parseFloat(opt.dataset.den),
                    price: parseFloat(opt.dataset.price)
                });
            });

            const payload = {
                metal: document.getElementById('sim-metal').value,
                target_temp: parseFloat(document.getElementById('sim-temp').value),
                ambient_temp: parseFloat(document.getElementById('sim-amb').value),
                layers: layersData,
                geometry: { dim1: 1.0 }
            };

            try {
                // ≈†aljemo na Python backend
                const response = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Gre≈°ka na serveru (404 ili 500)");
                
                const result = await response.json();

                // Prikazujemo rezultate
                document.getElementById('out-shell').innerText = result.shell_temp + " ¬∞C";
                document.getElementById('out-flux').innerText = result.heat_flux + " W/m¬≤";
                document.getElementById('out-liq').innerText = (result.liquidus_temp || "---") + " ¬∞C";
                document.getElementById('out-cost').innerText = result.total_cost + " ‚Ç¨";

                drawChart(result.profile, result.liquidus_temp);

            } catch (err) {
                console.error(err);
                alert("Gre≈°ka u kalkulaciji! Proveri da li je Deploy zavr≈°en na Renderu.");
            } finally {
                btn.innerText = "POKRENI SIMULACIJU üöÄ";
            }
        }

        // 4. CRTANJE GRAFIKA
        function drawChart(profile, limit) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (CHART) CHART.destroy();

            const labels = profile.map(p => p.pos + "mm");
            const data = profile.map(p => p.temp);

            CHART = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura kroz zid (¬∞C)',
                        data: data,
                        borderColor: 'orange',
                        borderWidth: 3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#444' } },
                        x: { grid: { color: '#444' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
